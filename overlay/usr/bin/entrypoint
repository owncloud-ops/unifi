#!/usr/bin/env sh
# shellcheck disable=SC2039
set -eo pipefail
source /usr/local/lib/log.sh

BASEDIR="/opt/app/unifi"
CERTDIR=${BASEDIR}/cert
DATADIR=${BASEDIR}/data
LOGDIR=${BASEDIR}/logs
RUNDIR=${BASEDIR}/run

/usr/local/bin/gomplate -o  ${DATADIR}/system.properties -f /etc/templates/system.properties.tmpl

JVM_OPTS="${JVM_EXTRA_OPTS} -Djava.awt.headless=true -Dfile.encoding=UTF-8"

if [ -n "$UNIFI_DB_HOST" ]
then
    log_info "Wait for mongiDB server on '${UNIFI_DB_HOST}:${UNIFI_DB_PORT:-27017}'"
    /usr/local/bin/wait-for "${UNIFI_DB_HOST}":"${UNIFI_DB_PORT:-27017}"
else
    log_error "Required environment variable '\$UNIFI_DB_HOST' not set"
    exit 1
fi

log_info "Start Unifi Controller\n"
exec /usr/bin/java ${JVM_OPTS} -jar ${BASEDIR}/lib/ace.jar start
